name: message board

on:
  issues:
    types: [opened, edited, reopened]
  workflow_dispatch: # 允许手动触发

jobs:
  process-issue:
    runs-on: ubuntu-latest
    
    # 只有包含特定标签或特定格式的 issue 才触发
    if: |
      contains(github.event.issue.labels.*.name, 'notes') ||
      startsWith(github.event.issue.title, '[DATA]')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Extract and format message data
      id: extract-data
      run: |
        # 使用 Python 提取和格式化数据
        python3 << EOF
        import json
        import re
        from datetime import datetime
        import base64
        
        issue_body = """${{ github.event.issue.body }}"""
        issue_number = ${{ github.event.issue.number }}
        author = "${{ github.event.issue.user.login }}"
        
        # 提取消息内容
        patterns = [
            r'消息:\s*(.+)',
            r'内容:\s*(.+)', 
            r'值:\s*(.+)',
            r'留言:\s*(.+)'
        ]
        
        message_content = ""
        for pattern in patterns:
            match = re.search(pattern, issue_body)
            if match:
                message_content = match.group(1).strip()
                break
        
        # 如果没有找到格式化的内容
        if not message_content:
            if issue_body.strip():
                message_content = issue_body.split('\\n')[0].strip()
            else:
                title = "${{ github.event.issue.title }}"
                message_content = title.replace('[DATA] ', '')
        
        # 清理消息内容（移除换行符，确保每行一条数据）
        message_content = re.sub(r'[\\r\\n]+', ' ', message_content).strip()
        
        # 创建格式化数据行：ID|时间戳|作者|内容
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        formatted_line = f"{issue_number}|{timestamp}|{author}|{message_content}"
        
        # 对内容进行Base64编码，避免特殊字符问题
        encoded_line = base64.b64encode(formatted_line.encode('utf-8')).decode('utf-8')
        
        print(f"原始消息: {message_content}")
        print(f"格式化行: {formatted_line}")
        print(f"编码后: {encoded_line}")
        
        # 使用新的输出方式
        with open('$GITHUB_OUTPUT', 'a') as f:
            f.write(f'message_content={message_content}\\n')
            f.write(f'formatted_line={formatted_line}\\n')
            f.write(f'encoded_line={encoded_line}\\n')
            f.write(f'issue_number={issue_number}\\n')
        EOF

    - name: Update messages data file
      run: |
        # 定义变量
        ENCODED_LINE="${{ steps.extract-data.outputs.encoded_line }}"
        MAX_LINES=100000
        
        # 数据文件路径
        DATA_FILE="messages.dat"
        
        echo "添加新消息到数据文件..."
        
        # 使用 Node.js 处理数据文件
        node << EOF
        const fs = require('fs');
        const dataFile = '$DATA_FILE';
        const newLine = '$ENCODED_LINE';
        const maxLines = $MAX_LINES;
        
        let lines = [];
        
        // 读取现有数据
        if (fs.existsSync(dataFile)) {
          try {
            const content = fs.readFileSync(dataFile, 'utf8');
            lines = content.split('\\n').filter(line => line.trim() !== '');
            console.log(\`读取到 \${lines.length} 条现有记录\`);
          } catch (error) {
            console.log('读取现有数据失败，创建新文件:', error.message);
          }
        }
        
        // 在开头添加新行
        lines.unshift(newLine);
        
        // 如果超过最大行数，截断数组
        if (lines.length > maxLines) {
          console.log(\`超过 \${maxLines} 条记录，移除最旧的 \${lines.length - maxLines} 条\`);
          lines = lines.slice(0, maxLines);
        }
        
        // 写回文件（每行一条数据）
        fs.writeFileSync(dataFile, lines.join('\\n') + '\\n', 'utf8');
        console.log(\`数据文件更新完成，现在有 \${lines.length} 条记录\`);
        
        // 显示前几条记录作为验证
        if (lines.length > 0) {
          console.log('前5条记录:');
          lines.slice(0, 5).forEach((line, index) => {
            console.log(\`\${index + 1}: \${line}\`);
          });
        }
        EOF

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "自动更新: 添加 Issue #${{ steps.extract-data.outputs.issue_number }} 的留言到数据文件"
        git push